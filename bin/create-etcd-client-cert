#!/bin/sh

if [ -z $1 ]; then
    echo Usage: $0 CommonName 1>&2
    echo 1>&2
    echo Example: $0 client.example.com 1>&2
    echo 1>&2
    exit 1
fi

# automatically append "-client" in the CommonName client certificate
export CN=$1-client
unset SAN

export ETCD_CA_DIR=${CLOUDCONFIG_INSTALL_DIR}/var/etcd-ca

CONFIG_FILE=${CLOUDCONFIG_INSTALL_DIR}/conf/openssl.cnf

KEY_FILE=${ETCD_CA_DIR}/private/${CN}.key
CSR_FILE=${ETCD_CA_DIR}/${CN}.csr
CRT_FILE=${ETCD_CA_DIR}/certs/${CN}.crt

openssl req -config ${CONFIG_FILE} -new -nodes -keyout ${KEY_FILE} -out ${CSR_FILE}

if [ $? -ne 0 ]; then
    echo "Could not create certificate signing request. Aborting!" 1>&2
    exit 1
fi

openssl ca -config ${CONFIG_FILE} -extensions etcd_client -out ${CRT_FILE} -infiles ${CSR_FILE}

if [ $? -ne 0 ]; then
    echo "Could not create certificate. Aborting!" 1>&2
    exit 1
fi

# remove temp cert signing request file
rm ${CSR_FILE}

echo
echo Created client certificate in ${CRT_FILE}
echo Created private key in ${KEY_FILE}